name: Release to prod

permissions:
  contents: write

on:
  workflow_dispatch:

jobs:
  release-to-prod:
    runs-on: ubuntu-latest

    steps:
      # 1) Checkout branche test
      - name: Checkout test branch
        uses: actions/checkout@v4
        with:
          ref: test
          fetch-depth: 0
          persist-credentials: false
          token: ${{ secrets.PAT_TOKEN }}

      - name: Configure git
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

      # 2) Mettre à jour la branche prod depuis test (même logique qu'avant)
      - name: Update prod branch from test
        run: |
          git checkout -B prod
          git push https://${{ secrets.PAT_TOKEN }}@github.com/${{ github.repository }}.git HEAD:prod --force

      # 3) Cloner le Space HF PROD
      - name: Clone Hugging Face Space PROD
        env:
          HF_TOKEN: ${{ secrets.HF_TOKEN }}
        run: |
          git clone https://huggingface:${HF_TOKEN}@huggingface.co/spaces/damienguesdon/attrition-esn-demo.git hf-space-prod
          cd hf-space-prod
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git config user.name "github-actions[bot]"

      # 4) Pousser le contenu de la branche prod vers le Space PROD
      #    en ne mettant à jour que app/, README.md, requirements.txt
      - name: Sync prod branch into HF Space PROD
        env:
          HF_TOKEN: ${{ secrets.HF_TOKEN }}
        run: |
          # On est dans le repo GitHub sur la branche prod (après le checkout -B prod)
          # Copier uniquement ce qu'on veut mettre à jour dans le Space PROD
          cp -r app hf-space-prod/
          cp README.md hf-space-prod/
          cp requirements.txt hf-space-prod/

          cd hf-space-prod
          git status

          git add app README.md requirements.txt || true
          git commit -m "Sync from GitHub prod branch (app + README + requirements)" || echo "Nothing to commit"

          git push origin main
